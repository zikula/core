<?php
/**
 * Routes.
 *
 * @copyright Zikula contributors (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Zikula contributors <support@zikula.org>.
 * @link http://www.zikula.org
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.1 (http://modulestudio.de).
 */

namespace Zikula\RoutesModule\Form\Handler\Route;

use Symfony\Component\Routing\RouteCollection;
use Zikula\RoutesModule\Entity\RouteEntity;
use Zikula\RoutesModule\Form\Handler\Route\Base\AbstractEditHandler;

/**
 * This handler class handles the page events of the Form called by the zikulaRoutesModule_route_edit() function.
 * It aims on the route object type.
 */
class EditHandler extends AbstractEditHandler
{
    /**
     * {@inheritdoc}
     */
    public function applyAction(array $args = [])
    {
        $this->sanitizeInput();
        if ($this->hasConflicts()) {
            return false;
        }

        $return = parent::applyAction($args);

        $cacheClearer = $this->container->get('zikula.cache_clearer');
        $cacheClearer->clear('symfony.routing');

        return $return;
    }

    /**
     * Ensures validity of input data.
     */
    private function sanitizeInput()
    {
        $entity = $this->entityRef;

        list($controller, ) = $this->sanitizeController($entity['controller']);
        list($action, ) = $this->sanitizeAction($entity['action']);

        $entity['controller'] = $controller;
        $entity['action'] = $action;
        $entity['group'] = RouteEntity::POSITION_MIDDLE;
        $entity['sort'] = 0;

        $this->entityRef = $entity;
    }

    /**
     * Checks for potential conflict.
     *
     * @return boolean True if a critical error occured, else false.
     */
    private function hasConflicts()
    {
        $routeEntity = $this->entityRef;

        $newPath = $routeEntity->getPathWithBundlePrefix();

        /** @var RouteCollection $routeCollection */
        $routeCollection = $this->router->getRouteCollection();

        $errors = [];
        foreach ($routeCollection->all() as $route) {
            $path = $route->getPath();
            if ($path === '/{url}') {
                continue;
            }

            if ($path === $newPath) {
                $errors[] = [
                    'type' => 'SAME',
                    'path' => $path
                ];
                continue;
            }

            $pathRegExp = preg_quote(preg_replace("/{(.+)}/", "____DUMMY____", $path), '/');
            $pathRegExp = "#^" . str_replace('____DUMMY____', '(.+)', $pathRegExp) . "$#";

            $matches = [];
            preg_match($pathRegExp, $newPath, $matches);
            if (count($matches)) {
                $errors[] = [
                    'type' => 'SIMILAR',
                    'path' => $path
                ];
            }
        }

        $hasCriticalErrors = false;

        foreach ($errors as $error) {
            if ($error['type'] == 'SAME') {
                $message = $this->__('It looks like you created or updated a route with a path which already exists. This is an error in most cases.');
                $hasCriticalErrors = true;
            } else {
                $message = $this->__f('The path of the route you created or updated looks similar to the following already existing path: %s Are you sure you haven\'t just introduced a conflict?', ['%s' => $error['path']]);
            }
            \LogUtil::registerError($message);
        }

        return $hasCriticalErrors;
    }

    /**
     * Sanitizes the action / func parameter.
     *
     * @param string $action
     *
     * @return array ($action, $func)
     */
    private function sanitizeAction($action)
    {
        if (substr($action, -6) !== 'Action') {
            $action .= 'Action';
        }

        $action = ucfirst($action);
        $func = lcfirst(substr($action, 0, -6));

        return [$action, $func];
    }

    /**
     * Sanitizes the controller / type parameter.
     *
     * @param string $controller
     *
     * @return array ($controller, $type)
     */
    private function sanitizeController($controller)
    {
        if (substr($controller, -10) !== 'Controller') {
            $type = $controller;
            $controller .= 'Controller';
        } else {
            $type = substr($controller, 0, -10);
        }

        $type = strtolower($type);
        $controller = ucfirst($controller);

        return [$controller, $type];
    }
}
